<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Wayline Maps</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="index.css" />
</head>
<body>
    <div class="search-container">
        <input type="text" id="search-input" placeholder="Search for a location...">
        <button id="search-button">Search</button>
        <button id="clear-button">Clear</button>
    </div>

    <div id="map"></div>
    <div id="distance-display" style="position:absolute;bottom:10px;right:10px;background:white;padding:8px;border-radius:5px;z-index:1000;display:none;box-shadow:0 1px 5px rgba(0,0,0,0.65);"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([13.08, 80.27], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        let startPoint = null;
        let endPoint = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;

        const distanceDisplay = document.getElementById("distance-display");

        function clearRoute() {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeLayer) map.removeLayer(routeLayer);
            startPoint = null;
            endPoint = null;
            startMarker = null;
            endMarker = null;
            routeLayer = null;
            distanceDisplay.style.display = "none";
        }

        async function getRoute() {
            const from = `${startPoint.lng},${startPoint.lat}`;
            const to = `${endPoint.lng},${endPoint.lat}`;
            const apiUrl = `/api/route?from=${from}&to=${to}`;
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error('Network response was not ok');
                const routeGeoJSON = await response.json();
                routeLayer = L.geoJSON(routeGeoJSON, { style: { color: '#007bff', weight: 5 } }).addTo(map);
                map.fitBounds(routeLayer.getBounds());

                const coords = routeGeoJSON.coordinates;
                let distance = 0;
                for (let i = 1; i < coords.length; i++) {
                    const from = L.latLng(coords[i - 1][1], coords[i - 1][0]);
                    const to = L.latLng(coords[i][1], coords[i][0]);
                    distance += from.distanceTo(to);
                }
                distanceDisplay.innerText = `Distance: ${(distance / 1000).toFixed(2)} km`;
                distanceDisplay.style.display = "block";

            } catch (error) {
                console.error('Error fetching route:', error);
                alert("Could not calculate the route.");
            }
        }

        async function searchLocation() {
            const query = document.getElementById('search-input').value;
            if (!query) return;

            try {
                const response = await fetch(`/api/geocode?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.error || !data.lat || !data.lon) {
                    alert('Location not found.');
                    return;
                }

                clearRoute();

                startPoint = { lat: parseFloat(data.lat), lng: parseFloat(data.lon) };
                startMarker = L.marker(startPoint, { icon: blueIcon }).addTo(map)
                    .bindPopup(`<b>Start Point</b><br>${data.address || query}`).openPopup();

                map.flyTo(startPoint, 15);
            } catch (err) {
                console.error("Error fetching geocode:", err);
                alert('Failed to search location.');
            }
        }

        document.getElementById('search-button').addEventListener('click', searchLocation);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchLocation();
        });
        document.getElementById('clear-button').addEventListener('click', clearRoute);

        const blueIcon = new L.Icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        const redIcon = new L.Icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        map.on('click', async function(e) {
            if (startPoint && endPoint) {
                clearRoute();
            }

            const lat = e.latlng.lat;
            const lng = e.latlng.lng;
            let address = `Lat: ${lat.toFixed(5)}, Lng: ${lng.toFixed(5)}`;

            try {
                const response = await fetch(`/api/reverse-geocode?lat=${lat}&lng=${lng}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.address) {
                        address = data.address;
                    }
                }
            } catch (error) {
                console.error("Reverse geocoding failed", error);
            }

            if (!startPoint) {
                startPoint = e.latlng;
                startMarker = L.marker(startPoint, { icon: blueIcon }).addTo(map)
                    .bindPopup(`<b>Start Point</b><br>${address}`).openPopup();
            } else {
                endPoint = e.latlng;
                endMarker = L.marker(endPoint, { icon: redIcon }).addTo(map)
                    .bindPopup(`<b>End Point</b><br>${address}`).openPopup();
                getRoute();
            }
        });
    </script>
</body>
</html>
